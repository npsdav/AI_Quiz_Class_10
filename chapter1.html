<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chapter 1 • AI Project Cycle – Quiz</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-1:#0b0f1a; --bg-2:#0a0a0a; --glass:#0f172acc; --border:#283245; --text:#ffffff; --muted:#cdd6e3; --accent:#7c3aed; --accent-2:#22d3ee; --green:#10b981; --red:#ef4444; --amber:#f59e0b; --option:#121826; --option-hover:#1c2435;
    }
    *{box-sizing:border-box}
    body{margin:0; color:var(--text); font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background: radial-gradient(1000px 600px at 10% -10%, #1e293b 0%, transparent 55%),
                  radial-gradient(800px 500px at 100% 10%, #0ea5e9 0%, transparent 45%),
                  linear-gradient(180deg, var(--bg-1), var(--bg-2));}
    header{position:sticky; top:0; z-index:20; backdrop-filter:saturate(160%) blur(8px); background:linear-gradient(180deg,#0f172a88,#0b132288); border-bottom:1px solid var(--border)}
    .wrap{max-width:960px; margin:0 auto; padding:14px 16px}
    .title{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap}
    .brand{display:flex; align-items:center; gap:12px}
    .badge{display:inline-flex; align-items:center; gap:8px; background:#0b1322; border:1px solid var(--border); border-radius:999px; padding:8px 12px; font-weight:700}
    .btn{border:none; border-radius:12px; padding:10px 14px; font-weight:700; cursor:pointer; transition:transform .06s ease, box-shadow .2s ease}
    .btn:hover{transform:translateY(-1px)}
    .btn.secondary{background:#0b1322; color:#fff; border:1px solid var(--border)}
    .btn.red{background:var(--red); color:#fff}
    main{max-width:960px; margin:0 auto; padding:20px 16px}
    .card{border:1px solid var(--border); border-radius:18px; background:linear-gradient(180deg,var(--glass),#0b132aaa); box-shadow:0 24px 60px rgba(0,0,0,.35)}
    .card-body{padding:18px}
    .qhead{display:flex; align-items:flex-start; justify-content:space-between; gap:12px}
    .qtext{font-size:1.1rem; font-weight:800; letter-spacing:.2px}
    .pill{background:#0b1322; border:1px solid var(--border); border-radius:999px; padding:8px 12px; font-weight:700}
    .options{display:grid; grid-template-columns:1fr; gap:12px; margin-top:16px}
    @media(min-width:640px){ .options{grid-template-columns:1fr 1fr} }
    .option{background:var(--option); color:var(--text); border:2px solid var(--border); border-radius:14px; padding:14px; text-align:left; cursor:pointer; font-weight:700; transition:background .15s ease, border-color .15s ease, transform .06s ease}
    .option:hover{background:var(--option-hover)}
    .option:focus-visible{outline:3px solid var(--amber); outline-offset:3px}
    .option.correct{background:#052e14; border-color:var(--green)}
    .option.wrong{background:#3a0b0b; border-color:var(--red)}
    .option.disabled{opacity:.78; pointer-events:none}
    .bar{position:relative; height:12px; border-radius:999px; background:#0b1322; border:1px solid var(--border); overflow:hidden; margin-top:12px}
    .bar span{position:absolute; left:0; top:0; bottom:0; width:0; background:linear-gradient(90deg,var(--amber),var(--green))}
    .controls{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top:16px; flex-wrap:wrap}
    .muted{color:var(--muted)}
    .result{border:1px solid var(--border); border-radius:18px; background:linear-gradient(180deg,var(--glass),#0b132aaa); box-shadow:0 24px 60px rgba(0,0,0,.35); padding:22px; text-align:center}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <header>
    <div class="wrap title">
      <div class="brand">
        <div class="badge">Chapter 1 • AI Project Cycle</div>
        <div class="badge">Class 10 • Subject 417</div>
      </div>
      <div class="badge">Score: <span id="scoreVal">0</span>/10</div>
      <div class="badge">Q <span id="qNow">1</span>/10</div>
      <div style="display:flex; gap:8px; flex-wrap:wrap">
        <button class="btn secondary" id="restartTop">Restart</button>
        <button class="btn red" id="endTop">End Quiz</button>
      </div>
    </div>
  </header>

  <main>
    <div class="card" id="quizCard" aria-live="polite"><div class="card-body"></div></div>
    <div class="result" id="resultCard" style="display:none">
      <h2>Test Complete</h2>
      <p class="muted">Your score: <strong id="finalScore">0/10</strong></p>
      <div class="controls" style="justify-content:center">
        <button class="btn secondary" id="homeBtn">Back to Home</button>
        <button class="btn secondary" id="againBtn">Take Another Test</button>
      </div>
      <p class="muted" style="margin-top:10px">Developed by: Nirender Prakash Singh, PGT(CS), DAV Public School, Bhagalpur</p>
    </div>
  </main>

<script>
  // ===== Config =====
  const QUESTIONS_PER_TEST = 10;                 // target number of questions per session
  const SECONDS_PER_QUESTION = 30;               // per-question timer
  const CSV_URL = 'https://npsdav.github.io/AI_Quiz_Class_10/chapter1_ai_project_cycle.csv'; // <-- set your CSV path

  // ===== State =====
  const STATE = {
    deck: [],            // current shuffled questions
    index: 0,            // current question position
    score: 0,            // number of correct answers
    selected: {},        // {questionIndex: chosenOptionIndex|null (timeout)}
    timer: { left: SECONDS_PER_QUESTION, id: null },
    actualCount: 0,      // number of questions loaded in this session
    loaded: false        // whether CSV has been loaded
  };

  // ===== Utils =====
  function shuffle(a) {
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  async function loadCSVDeck(url) {
    const res = await fetch(url, { cache: 'no-store' });
    if (!res.ok) throw new Error('Failed to load CSV: ' + res.status);
    const text = await res.text();

    const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
    if (parsed.errors && parsed.errors.length) {
      console.warn('CSV parse errors:', parsed.errors);
    }
    const rows = parsed.data;

    // Map rows to normalized question objects
    const items = rows.map((r, idx) => {
      const q = (r.q || '').trim();
      const rawOptions = (r.options || '').split('|').map(s => s.trim()).filter(Boolean);
      // answer is 0-based in your format
      const answerIndex = Number(r.answer);
      const explain = (r.explain || '').trim();

      // Basic validation
      if (!q || rawOptions.length === 0 || Number.isNaN(answerIndex) || answerIndex < 0 || answerIndex >= rawOptions.length) {
        console.warn(`Skipping invalid row #${idx + 2}:`, r);
        return null;
      }

      // Shuffle options but keep track of the correct one
      const optsWithIndex = rawOptions.map((text, oi) => ({ text, oi }));
      shuffle(optsWithIndex);
      const shuffledOptions = optsWithIndex.map(o => o.text);
      const correctShuffledIndex = optsWithIndex.findIndex(o => o.oi === answerIndex);

      return { q, options: shuffledOptions, answer: correctShuffledIndex, explain };
    }).filter(Boolean);

    // Build deck for this session
    shuffle(items);
    const target = Math.min(QUESTIONS_PER_TEST, items.length);
    STATE.deck = items.slice(0, target);
    STATE.actualCount = STATE.deck.length;
    STATE.loaded = true;
  }

  // ===== DOM =====
  const quizCard = document.getElementById('quizCard');
  const quizBody = quizCard.querySelector('.card-body');
  const scoreVal = document.getElementById('scoreVal');
  const qNow = document.getElementById('qNow');
  const resultCard = document.getElementById('resultCard');
  const finalScore = document.getElementById('finalScore');

  document.getElementById('restartTop').addEventListener('click', restart);
  document.getElementById('endTop').addEventListener('click', finish);
  document.getElementById('homeBtn').addEventListener('click', () => location.href = 'index.html');
  document.getElementById('againBtn').addEventListener('click', restart);

  // ===== Rendering =====
  function renderQuestion() {
    if (!STATE.loaded || STATE.actualCount === 0) {
      quizBody.innerHTML = '<div class="muted">Loading questions…</div>';
      return;
    }

    resultCard.style.display = 'none';
    quizCard.style.display = 'block';

    const item = STATE.deck[STATE.index];
    if (!item) { finish(); return; }

    qNow.textContent = (STATE.index + 1);
    quizBody.innerHTML = '';

    // Header
    const head = document.createElement('div');
    head.className = 'qhead';

    const htext = document.createElement('div');
    htext.className = 'qtext';
    htext.textContent = item.q; // plain text (no HTML)

    const timer = document.createElement('div');
    timer.className = 'pill';
    timer.setAttribute('role', 'status');
    timer.setAttribute('aria-live', 'polite');
    timer.innerHTML = `<strong>Time:</strong> <span id="timerLabel">${SECONDS_PER_QUESTION}s</span>`;
    head.appendChild(htext);
    head.appendChild(timer);

    // Progress bar
    const bar = document.createElement('div');
    bar.className = 'bar';
    const fill = document.createElement('span');
    fill.id = 'timeFill';
    bar.appendChild(fill);

    // Options
    const opts = document.createElement('div');
    opts.className = 'options';
    item.options.forEach((opt, oi) => {
      const b = document.createElement('button');
      b.className = 'option';
      b.type = 'button';
      b.textContent = opt;
      b.addEventListener('click', () => choose(oi));
      opts.appendChild(b);
    });

    // Controls
    const ctr = document.createElement('div');
    ctr.className = 'controls';
    const info = document.createElement('span');
    info.className = 'muted';
    info.textContent = 'Tap an option to answer (revision mode: no penalty)';

    const nextBtn = document.createElement('button');
    nextBtn.className = 'btn secondary';
    nextBtn.id = 'nextBtn';
    nextBtn.textContent = (STATE.index === STATE.actualCount - 1 ? 'Finish' : 'Next');
    nextBtn.disabled = true;
    nextBtn.addEventListener('click', next);

    const endBtn = document.createElement('button');
    endBtn.className = 'btn red';
    endBtn.textContent = 'End Quiz';
    endBtn.addEventListener('click', finish);

    ctr.appendChild(info);
    ctr.appendChild(nextBtn);
    ctr.appendChild(endBtn);

    quizBody.appendChild(head);
    quizBody.appendChild(bar);
    quizBody.appendChild(opts);
    quizBody.appendChild(ctr);

    startTimer();
  }

  function startTimer() {
    clearInterval(STATE.timer.id);
    STATE.timer.left = SECONDS_PER_QUESTION;
    updateTimerUI();
    STATE.timer.id = setInterval(() => {
      STATE.timer.left--;
      updateTimerUI();
      if (STATE.timer.left <= 0) {
        clearInterval(STATE.timer.id);
        timesUp();
      }
    }, 1000);
  }

  function updateTimerUI() {
    const label = document.getElementById('timerLabel');
    if (label) label.textContent = STATE.timer.left + 's';
    const fill = document.getElementById('timeFill');
    if (fill) {
      const elapsed = Math.max(0, SECONDS_PER_QUESTION - STATE.timer.left);
      fill.style.width = (elapsed / SECONDS_PER_QUESTION * 100) + '%';
    }
  }

  function lockOptions() {
    const options = quizBody.querySelectorAll('.option');
    options.forEach(btn => btn.disabled = true);
  }

  function choose(oi) {
    clearInterval(STATE.timer.id);
    if (typeof STATE.selected[STATE.index] !== 'undefined') return;

    const item = STATE.deck[STATE.index];
    const options = quizBody.querySelectorAll('.option');
    const correct = item.answer;

    STATE.selected[STATE.index] = oi;

    options.forEach((el, i) => {
      if (i === oi) {
        if (i === correct) {
          el.classList.add('correct');
          STATE.score++;     // revision mode: reward only correct
        } else {
          el.classList.add('wrong');
        }
      }
      if (i !== oi) el.classList.add('disabled');
    });

    // Show explanation if available
    if (item.explain) {
      const exp = document.createElement('div');
      exp.className = 'explain';
      exp.innerHTML = `<strong>Explanation:</strong> ${item.explain}`;
      quizBody.appendChild(exp);
    }

    scoreVal.textContent = STATE.score;
    lockOptions();
    const nextBtn = quizBody.querySelector('#nextBtn');
    if (nextBtn) nextBtn.disabled = false;
  }

  function timesUp() {
    const item = STATE.deck[STATE.index];
    if (!item) return;
    const correct = item.answer;
    const options = quizBody.querySelectorAll('.option');

    options.forEach((el, i) => {
      if (i === correct) el.classList.add('correct');
      else el.classList.add('disabled');
    });

    // Record timeout to block future selection
    if (typeof STATE.selected[STATE.index] === 'undefined') {
      STATE.selected[STATE.index] = null; // timeout/no attempt
    }

    // Show explanation if available
    if (item.explain) {
      const exp = document.createElement('div');
      exp.className = 'explain';
      exp.innerHTML = `<strong>Explanation:</strong> ${item.explain}`;
      quizBody.appendChild(exp);
    }

    lockOptions();
    const nextBtn = quizBody.querySelector('#nextBtn');
    if (nextBtn) nextBtn.disabled = false;
  }

  function next() {
    const nextBtn = quizBody.querySelector('#nextBtn');
    if (nextBtn) nextBtn.disabled = true;

    if (STATE.index < STATE.actualCount - 1) {
      STATE.index++;
      renderQuestion();
    } else {
      finish();
    }
  }

  function finish() {
    clearInterval(STATE.timer.id);
    quizCard.style.display = 'none';
    resultCard.style.display = 'block';
    finalScore.textContent = `${STATE.score}/${STATE.actualCount}`;
  }

  async function restart() {
    clearInterval(STATE.timer.id);
    STATE.index = 0;
    STATE.score = 0;
    STATE.selected = {};
    scoreVal.textContent = 0;
    qNow.textContent = 1;

    try {
      await loadCSVDeck(CSV_URL);
      renderQuestion();
    } catch (e) {
      quizBody.innerHTML = `<div class="error">Failed to load questions: ${e.message}</div>`;
    }
  }

  // Boot
  restart();
</script>
</body>
</html>
